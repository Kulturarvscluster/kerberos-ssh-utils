#!/usr/bin/env bash

#update prompt with kerberos user
updatePS1(){
    local kerberosUser=$( (klist 2>/dev/null || echo "") | grep -oP 'principal: \K\w+' )
    local PS_CLEANED=$(echo "$PS1" | sed 's/(krb:\w*) //g')
    export PS1="$PS_CLEANED"
    [ ! -z "$kerberosUser" ] && export PS1="(krb:$kerberosUser) $PS1"
}
updatePS1

#Update the prompt after successfull kinits
kinit(){
    /usr/bin/kinit $* && updatePS1
}
export kinit

kdestroy(){
    /usr/bin/kdestroy $* && updatePS1
}
export kdestroy

#Switch between kerberos accounts
switch_user(){
    local newUser="$1"
    local globalTicket="/tmp/krb5cc_$UID"
    if [ -n "$newUser" ]; then
        local userTicket="/tmp/${newUser}_kac.ticket"
        klist -c "${userTicket}" -s || /usr/bin/kinit -c "${userTicket}" "${newUser}@KAC.SBLOKALNET"
        rm -f "$globalTicket"
        ln -s "${userTicket}" "$globalTicket"
    else
        rm -f "$globalTicket"
    fi
    updatePS1
}

#autocomplete for logged in users
_switch_user()
{
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    opts="$(cd /tmp/ && ls *.ticket | sed 's/_kac\.ticket//g')"

    if [[ ${cur} == * ]] ; then
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
        return 0
    fi
}
complete -F _switch_user switch_user


function _log_debug(){
    local message="$@"
    echo " -> $message" >&2
    return 0;
}


ssh() {
(   #Subshell to handle exit correctly with the exec statements

    #Find the kac host
    local userHost=$(echo -e "$@" | grep -o "[^ ]*kac-[^ ]*" )

    #If kac host not found, just ssh
    if [ -z "$userHost" ];then
        local cmd="/usr/bin/ssh $*"
        _log_debug ${cmd}
        exec ${cmd}
    fi

    local lUser=$(echo -e "$@" | grep -o '^.*kac-' | grep -o '\-l *[^ ]\+' | sed 's/^-l//g' | sed 's/ //g')
    local hostUser=$(echo $userHost | grep '@' | cut -d'@' -f1)
    local specifiedUser=${hostUser:-$lUser}

    #If no user is specified, get user from current kerberos ticket
    if [ -z "$specifiedUser" ]; then
        local kerberosUser=$( (klist 2>/dev/null || echo "") | grep -oP 'principal: \K\w+' )
        if [ -n "$kerberosUser" ]; then
            # If the kerberos ticket specify a user, SSH as him
            local cmd="/usr/bin/ssh -l "${kerberosUser}" $*"
            _log_debug ${cmd}
            exec ${cmd}
        fi
    fi

    #Fallback to local user if nothing is specified
    local user=${specifiedUser:-$USER}

    #Cut the host part of the url
    local host=$(echo $userHost | cut -d'@' -f2)

    #Do not do kerberos tricks if logging in as root
    if [ "$user" == "root" ]; then
        local cmd="/usr/bin/ssh $*"
        _log_debug ${cmd}
        exec ${cmd}
    fi

    userTicket="/tmp/${user}_kac.ticket"

    local cmd="/usr/bin/klist -c ${userTicket} -s"
    _log_debug ${cmd}
    eval $cmd || (
        local cmd="/usr/bin/kinit -c ${userTicket} ${user}@KAC.SBLOKALNET"
        _log_debug ${cmd}
        eval ${cmd}
    )

    local cmd="env KRB5CCNAME=$userTicket /usr/bin/ssh -l ${user} $*"
    _log_debug ${cmd}
    exec ${cmd}
)}
export ssh

